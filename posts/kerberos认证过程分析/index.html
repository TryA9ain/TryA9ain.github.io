<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>Kerberos 认证过程分析 - TryA9ain-Blog</title><meta name="author" content="TryA9ain">
<meta name="author-link" content="">
<meta name="description" content="本文主要记录了通过 WireShark 解开 Kerberos 协议对其进行分析, 很多东西不仅要知其然, 更要知其所以然." /><meta name="keywords" content='域渗透' /><meta itemprop="name" content="Kerberos 认证过程分析">
<meta itemprop="description" content="本文主要记录了通过 WireShark 解开 Kerberos 协议对其进行分析, 很多东西不仅要知其然, 更要知其所以然."><meta itemprop="datePublished" content="2022-11-24T17:37:22+08:00" />
<meta itemprop="dateModified" content="2022-11-24T17:37:22+08:00" />
<meta itemprop="wordCount" content="2602">
<meta itemprop="keywords" content="域渗透," /><meta property="og:title" content="Kerberos 认证过程分析" />
<meta property="og:description" content="本文主要记录了通过 WireShark 解开 Kerberos 协议对其进行分析, 很多东西不仅要知其然, 更要知其所以然." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://TryA9ain.github.io/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-11-24T17:37:22+08:00" />
<meta property="article:modified_time" content="2022-11-24T17:37:22+08:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Kerberos 认证过程分析"/>
<meta name="twitter:description" content="本文主要记录了通过 WireShark 解开 Kerberos 协议对其进行分析, 很多东西不仅要知其然, 更要知其所以然."/>
<meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="https://TryA9ain.github.io/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/" /><link rel="prev" href="https://TryA9ain.github.io/posts/%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE/" /><link rel="next" href="https://TryA9ain.github.io/posts/nopac-%E5%88%86%E6%9E%90/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "Kerberos 认证过程分析",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https:\/\/TryA9ain.github.io\/posts\/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90\/"
    },"genre": "posts","keywords": "域渗透","wordcount":  2602 ,
    "url": "https:\/\/TryA9ain.github.io\/posts\/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90\/","datePublished": "2022-11-24T17:37:22+08:00","dateModified": "2022-11-24T17:37:22+08:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "TryA9ain"
      },"description": ""
  }
  </script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="TryA9ain-Blog"><span class="header-title-text">TryA9ain</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/posts/"
                
                
              >文章</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/"
                
                
              >分类</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/tags/"
                
                
              >标签</a></li><li class="menu-item delimiter"></li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="TryA9ain-Blog"><span class="header-title-text">TryA9ain</span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/posts/"
                  
                  
                >文章</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/"
                  
                  
                >分类</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/tags/"
                  
                  
                >标签</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="切换主题"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><main class="container"><aside class="toc" id="toc-auto"><h2 class="toc-title">目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside>

  <aside class="aside-custom">
    </aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>Kerberos 认证过程分析</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><img loading="lazy" src="/images/logo.jpeg" srcset="/images/logo.jpeg, /images/logo.jpeg 1.5x, /images/logo.jpeg 2x" sizes="auto" data-title="TryA9ain" data-alt="TryA9ain" class="avatar" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/>&nbsp;TryA9ain</span></span>
          <span class="post-category">收录于 <a href="/categories/%E5%9F%9F%E6%B8%97%E9%80%8F%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86/"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> 域渗透相关知识</a></span></div>
      <div class="post-meta-line"><span title="发布于 2022-11-24 17:37:22"><i class="fa-regular fa-calendar-alt fa-fw me-1" aria-hidden="true"></i><time datetime="2022-11-24">2022-11-24</time></span>&nbsp;<span title="更新于 2022-11-24 17:37:22"><i class="fa-regular fa-edit fa-fw me-1" aria-hidden="true"></i><time datetime="2022-11-24">2022-11-24</time></span>&nbsp;<span><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>约 2602 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>预计阅读 6 分钟</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>目录</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#kerberos-主要步骤">Kerberos 主要步骤</a></li>
    <li><a href="#as-req">AS-REQ</a>
      <ul>
        <li><a href="#整体请求内容">整体请求内容</a></li>
        <li><a href="#padata">padata</a></li>
        <li><a href="#req-body">req-body</a></li>
      </ul>
    </li>
    <li><a href="#krb-error-krb5kdc_err_preauth_required">KRB Error: KRB5KDC_ERR_PREAUTH_REQUIRED</a></li>
    <li><a href="#as-req-1">AS-REQ</a>
      <ul>
        <li><a href="#原数据包">原数据包</a>
          <ul>
            <li><a href="#整体请求内容-1">整体请求内容</a></li>
            <li><a href="#padata-1">padata</a></li>
            <li><a href="#req-body-1">req-body</a></li>
          </ul>
        </li>
        <li><a href="#解密后的数据包">解密后的数据包</a>
          <ul>
            <li><a href="#pa-data-pa-enc-timestamp">PA-DATA PA-ENC-TIMESTAMP</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#as-rep">AS-REP</a>
      <ul>
        <li><a href="#原数据包-1">原数据包</a>
          <ul>
            <li><a href="#整体相应内容">整体相应内容</a></li>
            <li><a href="#ticket">ticket</a></li>
            <li><a href="#enc-part">enc-part</a></li>
          </ul>
        </li>
        <li><a href="#解密后的数据包-1">解密后的数据包</a>
          <ul>
            <li><a href="#ticket-中的-enc-part">ticket 中的 enc-part</a></li>
            <li><a href="#enc-part-1">enc-part</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#tgs-req">TGS-REQ</a>
      <ul>
        <li><a href="#原数据包-2">原数据包</a>
          <ul>
            <li><a href="#整体请求内容-2">整体请求内容</a></li>
            <li><a href="#padata-2">padata</a></li>
            <li><a href="#req-body-2">req-body</a></li>
          </ul>
        </li>
        <li><a href="#解密后的数据包-2">解密后的数据包</a>
          <ul>
            <li><a href="#padata-3">padata</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#tgs-rep">TGS-REP</a>
      <ul>
        <li><a href="#原数据包-3">原数据包</a>
          <ul>
            <li><a href="#整体响应内容">整体响应内容</a></li>
            <li><a href="#ticket-1">ticket</a></li>
            <li><a href="#enc-part-2">enc-part</a></li>
          </ul>
        </li>
        <li><a href="#解密后的数据包-3">解密后的数据包</a>
          <ul>
            <li><a href="#ticket-2">ticket</a></li>
            <li><a href="#enc-part-3">enc-part</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#pac">PAC</a>
      <ul>
        <li><a href="#解密后的数据包-4">解密后的数据包</a>
          <ul>
            <li><a href="#普通域用户的-pac">普通域用户的 PAC</a></li>
            <li><a href="#域管的-pac">域管的 PAC</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#参考文章">参考文章</a></li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><p>本文主要记录了通过 WireShark 解开 Kerberos 协议对其进行分析, 很多东西不仅要知其然, 更要知其所以然.</p>
<h2 id="kerberos-主要步骤">Kerberos 主要步骤</h2>
<ol>
<li>AS-REQ</li>
<li>AS-REP</li>
<li>TGS-REQ</li>
<li>TGS-REP</li>
<li>AP-REQ</li>
<li>AP-REP</li>
</ol>
<p>这里重点分析前四点.</p>
<p><img loading="lazy" src="images/Pasted%20image%2020221105212043.png" srcset="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221105212043.png, images/Pasted%20image%2020221105212043.png 1.5x, /posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221105212043.png 2x" sizes="auto" data-title="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221105212043.png" data-alt="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221105212043.png" width="1900" height="330" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<h2 id="as-req">AS-REQ</h2>
<h3 id="整体请求内容">整体请求内容</h3>
<p><img loading="lazy" src="images/Pasted%20image%2020221116215126.png" srcset="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221116215126.png, images/Pasted%20image%2020221116215126.png 1.5x, /posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221116215126.png 2x" sizes="auto" data-title="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221116215126.png" data-alt="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221116215126.png" width="528" height="290" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<ul>
<li>pvno: Kerberos 的版本号, 可以看到是 Kerberos 5.</li>
<li>msg-type: 消息类型, 这里是 krb-as-req.</li>
<li>padata: Pre-authentication Data, 预认证数据 (我也不知道怎么翻译 🤣) 里面存放的是一些认证信息.</li>
<li>req-body: 请求体.</li>
</ul>
<h3 id="padata">padata</h3>
<p><img loading="lazy" src="images/Pasted%20image%2020221116215843.png" srcset="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221116215843.png, images/Pasted%20image%2020221116215843.png 1.5x, /posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221116215843.png 2x" sizes="auto" data-title="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221116215843.png" data-alt="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221116215843.png" width="672" height="206" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<ul>
<li>
<p>padata-type: <a href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-kile/765795ba-9e05-4220-9bd3-b34464e413a7"target="_blank" rel="external nofollow noopener noreferrer">pA-PAC-REQUEST</a> 一种 padata 类型, 明确请求在票据中包含或排除 PAC.</p>
<p>padata 的类型有很多种, 可以参考这篇文章: <a href="https://cwiki.apache.org/confluence/display/DIRxPMGT/Kerberos&#43;PA-DATA"target="_blank" rel="external nofollow noopener noreferrer">Kerberos PA-DATA</a>.</p>
</li>
<li>
<p>include-pac: True 包含PAC.</p>
<p><a href="#pac">PAC</a> (Privilege Attribute Certificate) 是一个做权限认证的扩展.</p>
</li>
</ul>
<h3 id="req-body">req-body</h3>
<p><img loading="lazy" src="images/Pasted%20image%2020221116221033.png" srcset="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221116221033.png, images/Pasted%20image%2020221116221033.png 1.5x, /posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221116221033.png 2x" sizes="auto" data-title="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221116221033.png" data-alt="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221116221033.png" width="816" height="924" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<ul>
<li>kdc-options: 用于与 KDC 约定一些选项设置.</li>
<li>cname: 客户端用户名.</li>
<li>realm: 域名.</li>
<li>sname: 服务端用户名, 在 AS-REQ 中 sname 是 krbtgt, 类型是 kRB5-NT-SRV-INST.</li>
<li>till: 到期时间.</li>
<li>nonce: 随机生成的一个数, 用于检测重放攻击.</li>
<li>etype: 协商加密类型, KDC 通过 etype 中的加密类型来选择用户对应的 NT Hash 来解密.</li>
</ul>
<h2 id="krb-error-krb5kdc_err_preauth_required">KRB Error: KRB5KDC_ERR_PREAUTH_REQUIRED</h2>
<p><img loading="lazy" src="images/Pasted%20image%2020221116223927.png" srcset="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221116223927.png, images/Pasted%20image%2020221116223927.png 1.5x, /posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221116223927.png 2x" sizes="auto" data-title="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221116223927.png" data-alt="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221116223927.png" width="1610" height="1206" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<p>第一个AS-REQ 对应的响应信息为 &ldquo;KRB Error: KRB5KDC_ERR_PREAUTH_REQUIRED&rdquo;.</p>
<p>这是因为在 Kerberos 5 之前, Kerberos 允许不使用密码进行身份认证, 而在 Kerberos 5 中, 密码信息是必须的, 这种过程称之为 &ldquo;预认证&rdquo;.</p>
<p>可能出于向后兼容考虑, Kerberos 在执行预认证之前首先会尝试不使用密码进行身份认证 (从第一个 AS-REQ 包中能看到并不包含密码信息), 因此 Kerberos 5 在登录期间发送初始 AS-REQ 后我们总是能看到一个错误信息.</p>
<p>预认证过程不包含密码信息, 接下来才是正常的 Kerberos 认证.</p>
<h2 id="as-req-1">AS-REQ</h2>
<p>用户输入帐号密码访问域内的服务, 本机会向 KDC 的 AS 认证服务发送一个 AS-REQ 请求, 请求主要包含用户 NT Hash 加密的时间戳, 请求用户名, 协商 NT Hash 的加密类型等信息.</p>
<h3 id="原数据包">原数据包</h3>
<h4 id="整体请求内容-1">整体请求内容</h4>
<p><img loading="lazy" src="images/Pasted%20image%2020221116224907.png" srcset="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221116224907.png, images/Pasted%20image%2020221116224907.png 1.5x, /posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221116224907.png 2x" sizes="auto" data-title="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221116224907.png" data-alt="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221116224907.png" width="498" height="206" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<ul>
<li>pvno: kerberos 的版本号.</li>
<li>msg-type: 消息类型, 这里就是 krb-as-req.</li>
<li>padata: Pre-authentication Data, 预认证数据 (我也不知道怎么翻译 🤣) 里面存放的是一些认证信息.</li>
<li>req-body: 请求体.</li>
</ul>
<h4 id="padata-1">padata</h4>
<p><img loading="lazy" src="images/Pasted%20image%2020221116225023.png" srcset="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221116225023.png, images/Pasted%20image%2020221116225023.png 1.5x, /posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221116225023.png 2x" sizes="auto" data-title="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221116225023.png" data-alt="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221116225023.png" width="1582" height="406" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<ul>
<li>PA-DATA PA-ENC-TIMESTAMP: 用户 NT Hash 加密后的时间戳
<ul>
<li>padata-type: padata 类型
<ul>
<li>padata-vaule: padata 的值
<ul>
<li>etype: 加密类型</li>
<li>cipher: 加密后的值</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>PA-DATA PA-PAC-REQUEST: PAC扩展
<ul>
<li>padata-type: padata 类型
<ul>
<li>padata-vaule: padata 的值</li>
<li>include-pac: 是否包含 PAC, True 为包含, False 为不包含.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="req-body-1">req-body</h4>
<p><img loading="lazy" src="images/Pasted%20image%2020221116225341.png" srcset="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221116225341.png, images/Pasted%20image%2020221116225341.png 1.5x, /posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221116225341.png 2x" sizes="auto" data-title="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221116225341.png" data-alt="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221116225341.png" width="824" height="920" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<ul>
<li>kdc-options: 用于与 KDC 约定一些选项设置.</li>
<li>cname: 客户端用户名.</li>
<li>realm: 域名.</li>
<li>sname: 服务端用户名, 在 AS-REQ 中 sname 是 krbtgt, 类型是 kRB5-NT-SRV-INST.</li>
<li>till: 到期时间.</li>
<li>nonce: 随机生成的一个数, 用于检测重放攻击。</li>
<li>etype: 协商加密类型, KDC 通过 etype 中的加密类型来选择用户对应的 NT Hash 来解密。</li>
</ul>
<h3 id="解密后的数据包">解密后的数据包</h3>
<blockquote>
<p>由于有的数据包过大, 贴完整的数据包出来意义不是特别大, 本文只贴一些重点的解包.</p>
</blockquote>
<h4 id="pa-data-pa-enc-timestamp">PA-DATA PA-ENC-TIMESTAMP</h4>
<p><img loading="lazy" src="images/Pasted%20image%2020221116230040.png" srcset="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221116230040.png, images/Pasted%20image%2020221116230040.png 1.5x, /posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221116230040.png 2x" sizes="auto" data-title="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221116230040.png" data-alt="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221116230040.png" width="2520" height="804" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<p>WireShark 对于每一个被解密的部分都进行了说明是使用 keytab 中的哪个主体进行解密的.</p>
<p>可以看到 PA-DATA pA-ENC-TIMESTAMP 是使用了 keytab 中 ligang 的信息来成功解密出时间戳.</p>
<h2 id="as-rep">AS-REP</h2>
<p>KDC 收到请求后, 通过活动目录查询到该用户的密码 NT Hash, 用该 NT Hash 对请求包的 pA-ENC-TIMESTAMP 进行解密, 解密成功后, 还会检查时间戳, 如果时间戳的范围在五分钟内且数据包无重放, 则认证成功.</p>
<p>认证成功后, KDC 会向客户端返回两个东西:</p>
<ul>
<li>用户 NT Hash 加密后的 Logon session key (AS 随机生成).</li>
<li>krbtgt NT Hash 加密后的 TGT.</li>
</ul>
<p>TGT 主要包含 Logon session key, 时间戳和 PAC.</p>
<p>Logon session key 的作用是作为用户和 KDC 后几个阶段之间通信加密的会话密钥.</p>
<h3 id="原数据包-1">原数据包</h3>
<h4 id="整体相应内容">整体相应内容</h4>
<p><img loading="lazy" src="images/Pasted%20image%2020221116230803.png" srcset="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221116230803.png, images/Pasted%20image%2020221116230803.png 1.5x, /posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221116230803.png 2x" sizes="auto" data-title="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221116230803.png" data-alt="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221116230803.png" width="494" height="326" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<p>主要来看 ticket 和 enc-part 这两部分:</p>
<ul>
<li>
<p>ticket: 即 TGT.</p>
</li>
<li>
<p>enc-part: 这部分是用户 NT Hash 加密的, 里面包含 Logon session key.</p>
</li>
</ul>
<h4 id="ticket">ticket</h4>
<p>这里的 ticket 其实就是 TGT.</p>
<p><img loading="lazy" src="images/Pasted%20image%2020221116231127.png" srcset="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221116231127.png, images/Pasted%20image%2020221116231127.png 1.5x, /posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221116231127.png 2x" sizes="auto" data-title="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221116231127.png" data-alt="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221116231127.png" width="1446" height="478" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<ul>
<li>tkt-vno: TGT 版本号.</li>
<li>realm: 域名.</li>
<li>sname: 请求的服务名称 krbtgt.</li>
<li>enc-part: 这部份是用 krbtgt NT Hash 加密的, 其中包含了请求用户的 <a href="#pac">PAC</a> 信息.</li>
</ul>
<h4 id="enc-part">enc-part</h4>
<p><img loading="lazy" src="images/Pasted%20image%2020221116231314.png" srcset="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221116231314.png, images/Pasted%20image%2020221116231314.png 1.5x, /posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221116231314.png 2x" sizes="auto" data-title="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221116231314.png" data-alt="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221116231314.png" width="1390" height="162" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<p>内容是由用户 NT Hash 加密的 Logon session key.</p>
<h3 id="解密后的数据包-1">解密后的数据包</h3>
<h4 id="ticket-中的-enc-part">ticket 中的 enc-part</h4>
<p>可以看到是用 krbtgt 的信息解密的, 解密出 Logon session key, 时间戳, <a href="#pac">PAC</a> (authorization-data 字段里的内容, 这里放到了后面来介绍).</p>
<p><img loading="lazy" src="images/Pasted%20image%2020221118231202.png" srcset="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221118231202.png, images/Pasted%20image%2020221118231202.png 1.5x, /posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221118231202.png 2x" sizes="auto" data-title="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221118231202.png" data-alt="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221118231202.png" width="2408" height="1204" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<h4 id="enc-part-1">enc-part</h4>
<p>用 ligang 用户信息解密出 Logon session key, 可以看到与 TGT 中的 Logon session key 是相同的.</p>
<p><img loading="lazy" src="images/Pasted%20image%2020221118231746.png" srcset="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221118231746.png, images/Pasted%20image%2020221118231746.png 1.5x, /posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221118231746.png 2x" sizes="auto" data-title="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221118231746.png" data-alt="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221118231746.png" width="2368" height="1204" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<h2 id="tgs-req">TGS-REQ</h2>
<p>用户通过 AS-REP 拿到 TGT 和用户 NT Hash 加密后的 Logon Session Key, 使用用自己的 NT Hash 解密获得 Logon session key, 再用 Logon session key 加密客户端用户名, 时间戳等信息和 TGT 一起向 KDC 的 TGS 服务发起请求请求 ST. (这一步不需要帐号或者密码主要以 TGT 作为凭证).</p>
<h3 id="原数据包-2">原数据包</h3>
<h4 id="整体请求内容-2">整体请求内容</h4>
<p><img loading="lazy" src="images/Pasted%20image%2020221117212656.png" srcset="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221117212656.png, images/Pasted%20image%2020221117212656.png 1.5x, /posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221117212656.png 2x" sizes="auto" data-title="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221117212656.png" data-alt="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221117212656.png" width="498" height="208" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<ul>
<li>padata: 这个部分包含之前的 AS-REP 中的 TGT 以及 Logon session key 加密的内容.</li>
<li>req-body: 请求体.</li>
</ul>
<h4 id="padata-2">padata</h4>
<p><img loading="lazy" src="images/Pasted%20image%2020221117213109.png" srcset="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221117213109.png, images/Pasted%20image%2020221117213109.png 1.5x, /posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221117213109.png 2x" sizes="auto" data-title="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221117213109.png" data-alt="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221117213109.png" width="1626" height="962" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<ul>
<li>AP-REQ: 这部分会携带 AS-REP 中获取到的 TGT, 客户端的认证信息.
<ul>
<li>ticket: 即 TGT.</li>
<li>authenticator: Logon session key 加密的客户端信息 (请求的用户名, 时间戳).</li>
</ul>
</li>
</ul>
<h4 id="req-body-2">req-body</h4>
<p><img loading="lazy" src="images/Pasted%20image%2020221117213246.png" srcset="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221117213246.png, images/Pasted%20image%2020221117213246.png 1.5x, /posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221117213246.png 2x" sizes="auto" data-title="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221117213246.png" data-alt="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221117213246.png" width="830" height="692" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<ul>
<li>realm: 域名.</li>
<li>sname: 请求的指定服务.</li>
<li>etype: 支持的加密类型.</li>
</ul>
<h3 id="解密后的数据包-2">解密后的数据包</h3>
<h4 id="padata-3">padata</h4>
<ul>
<li>
<p>padata &ndash;&gt; ap-rep &ndash;&gt; ticket</p>
<p>就是 AS-REP 中获取到的 TGT, TGT 解包前面已经解过了, 此处不在详细分析.</p>
</li>
<li>
<p>padata &ndash;&gt; ap-rep &ndash;&gt; authenticator</p>
<p>这部分就是 Logon session key 加密的客户端信息 (请求的用户名, 时间戳), 可以看到是由 AS-REP &ndash;&gt; enc-part &ndash;&gt; Logon session key (用户 NT Hash 加密的 cf4832b1 开头的值) 解密出来的.</p>
<!-- raw HTML omitted -->
</li>
</ul>
<p><img loading="lazy" src="images/Pasted%20image%2020221117215326.png" srcset="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221117215326.png, images/Pasted%20image%2020221117215326.png 1.5x, /posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221117215326.png 2x" sizes="auto" data-title="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221117215326.png" data-alt="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221117215326.png" width="2300" height="764" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<h2 id="tgs-rep">TGS-REP</h2>
<p>KDC 在收到上述请求后, 会用 krbtgt 的 NT Hash 解密提取 TGT 并从 TGT 中获取用户名, Logon session key 和时间戳, 接着再用 Logon session key 去解密 authenticator 获取到请求的用户名和时间戳, 将两处解密的用户名和时间戳进行对比, 并确认 TGT 是否还在生命周期内, 如果对比相同, 且 TGT 还在生命周期内, 则颁发 ST.</p>
<p>至此客户端 和 KDC 之间的通信已全部结束, 下面就该是客户端和服务端之间的交互了。</p>
<p>ST (服务票据) 中包含 Server Session key, 客户端名称, 票据有效时间, PAC 等信息.</p>
<h3 id="原数据包-3">原数据包</h3>
<h4 id="整体响应内容">整体响应内容</h4>
<p><img loading="lazy" src="images/Pasted%20image%2020221117220321.png" srcset="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221117220321.png, images/Pasted%20image%2020221117220321.png 1.5x, /posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221117220321.png 2x" sizes="auto" data-title="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221117220321.png" data-alt="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221117220321.png" width="494" height="286" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<ul>
<li>ticket: 这个就是 ST, 由服务帐号的 NT Hash 加密.</li>
<li>enc-part: Logon session key 加密的 Server Session key 等信息.</li>
</ul>
<h4 id="ticket-1">ticket</h4>
<p><img loading="lazy" src="images/Pasted%20image%2020221117221523.png" srcset="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221117221523.png, images/Pasted%20image%2020221117221523.png 1.5x, /posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221117221523.png 2x" sizes="auto" data-title="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221117221523.png" data-alt="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221117221523.png" width="1428" height="488" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<p>这个就是 ST, 由服务帐号的 NT Hash 加密.</p>
<h4 id="enc-part-2">enc-part</h4>
<p><img loading="lazy" src="images/Pasted%20image%2020221117221549.png" srcset="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221117221549.png, images/Pasted%20image%2020221117221549.png 1.5x, /posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221117221549.png 2x" sizes="auto" data-title="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221117221549.png" data-alt="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221117221549.png" width="1408" height="168" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<p>Logon session key 加密的 Server Session key 等信息.</p>
<h3 id="解密后的数据包-3">解密后的数据包</h3>
<h4 id="ticket-2">ticket</h4>
<p>可以看到是用 WIN-2008$ 服务帐号信息解密的.</p>
<ul>
<li>key: 这里 73950060 开头的 key 就是 Server Session key.</li>
<li>authorization-data: 用户的 <a href="#pac">PAC</a>.</li>
</ul>
<p><img loading="lazy" src="images/Pasted%20image%2020221117222619.png" srcset="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221117222619.png, images/Pasted%20image%2020221117222619.png 1.5x, /posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221117222619.png 2x" sizes="auto" data-title="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221117222619.png" data-alt="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221117222619.png" width="2440" height="1090" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<h4 id="enc-part-3">enc-part</h4>
<p>可以看到依旧是用 cf4832b1 开头的 Logon session key 解密出来的, 并且 Server Session key 和 ST 票据中的相同.</p>
<p>剩下的就是: 拿着 ST 去进行 AP-REQ 和 AP-REP 阶段了.</p>
<p><img loading="lazy" src="images/Pasted%20image%2020221117223247.png" srcset="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221117223247.png, images/Pasted%20image%2020221117223247.png 1.5x, /posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221117223247.png 2x" sizes="auto" data-title="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221117223247.png" data-alt="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221117223247.png" width="2296" height="1162" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<h2 id="pac">PAC</h2>
<p>PAC (Privilege Attribute Certificate, 特权属性证书), 其中所包含的是各种授权信息, PAC 用来表示用户的权限, 如果没有 PAC, Kerberos 协议就仅能证明用户身份, 无法表示用户权限.</p>
<p>TGT 和 ST 中的 authorization-data 字段里的内容就是 PAC.</p>
<p>有PAC 的请求流程:</p>
<ul>
<li>
<p>用户发起 AS-REQ, KDC 从 AS-REQ 请求中取出 cname 字段并查询活动目录, 找到 sAMAccountName 属性为 cname 字段的值的用户, 用该用户的身份生成一个对应的 PAC. 用户也可以指定 include-pac: False/True 来要求 KDC 在返回的票据中是否包含 PAC.</p>
</li>
<li>
<p>用户发起 TGS-REQ, KDC 收到 TGT 后, 利用 krbtgt 密钥对其解密并验证 PAC 的签名. 如果签名正确, 则证明 PAC 未经过篡改, 然后在 PAC 的尾部重新生成两个签名: Server Signature (要请求的服务的 NT Hash 生成的签名) 和 KDC Signature. 然后把新的 PAC 拷贝到 ST 中. (此步骤不校验 PAC 中用户有没有访问服务的权限, 只要 TGT 正确就返回 ST).</p>
<blockquote>
<p>如果是 S4U2self 请求的话, ST 中的 PAC 是重新生成的 (生成的是模拟用户的 PAC).</p>
</blockquote>
</li>
<li>
<p>用户拿着 ST 去请求服务, 服务使用 NT Hash 解密 ST 获取 PAC 后检查用户的 SID (UserId), 所在组 (GroupIds) 并与自身的 ACL 进行对比, 判断用户是否有访问服务的权限. (如果服务开启了验证 PAC 的签名, 还会向 KDC 发送 KERB_VERIFY_PAC 验证 PAC 的签名).</p>
</li>
</ul>
<blockquote>
<p>如果 TGT 中不带有 PAC, 那么 ST 中也不会带有 PAC, 也就没有权限访问任何服务.</p>
</blockquote>
<h3 id="解密后的数据包-4">解密后的数据包</h3>
<h4 id="普通域用户的-pac">普通域用户的 PAC</h4>
<p>主要来看下 Type: Logon Info (1), 这个结构是登录信息, 主要靠它来验证用户身份.</p>
<p><img loading="lazy" src="images/Pasted%20image%2020221105224416.png" srcset="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221105224416.png, images/Pasted%20image%2020221105224416.png 1.5x, /posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221105224416.png 2x" sizes="auto" data-title="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221105224416.png" data-alt="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221105224416.png" width="2896" height="1278" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<p>Type: Logon Info (1) 展开主要注意:</p>
<ul>
<li>
<p>Acct Name: ligang</p>
</li>
<li>
<p>GroupRIDs</p>
<ul>
<li>Group_MEMBERSHIP:
<ul>
<li>Group RID: 513</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>表示 ligang 这个帐户在 Group RID: 513 (域用户组) 中.</p>
<p><img loading="lazy" src="images/Pasted%20image%2020221118215602.png" srcset="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221118215602.png, images/Pasted%20image%2020221118215602.png 1.5x, /posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221118215602.png 2x" sizes="auto" data-title="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221118215602.png" data-alt="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/Pasted%20image%2020221118215602.png" width="1486" height="1090" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<h4 id="域管的-pac">域管的 PAC</h4>
<ul>
<li>
<p>Acct Name: yunwei</p>
</li>
<li>
<p>GroupRIDs</p>
<ul>
<li>Group_MEMBERSHIP:
<ul>
<li>Group RID: 513</li>
</ul>
</li>
<li>Group_MEMBERSHIP:
<ul>
<li>Group RID: 512</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>可以看到 yunwei 这个帐户在 Group RID: 513 (域用户组) 和 Group RID: 512 (域管组) 中, 所以 yunwei 是域管.</p>
<p><img loading="lazy" src="images/PAC.png" srcset="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/PAC.png, images/PAC.png 1.5x, /posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/PAC.png 2x" sizes="auto" data-title="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/PAC.png" data-alt="/posts/kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/images/PAC.png" width="2016" height="2291" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<p><strong>感谢耐心阅读, 文章仅供参考, 本人学艺不精, 不足之处欢迎师傅们指点和纠正!</strong></p>
<h2 id="参考文章">参考文章</h2>
<p><a href="https://loong716.top/posts/Kerberos/"target="_blank" rel="external nofollow noopener noreferrer">再谈Kerberos</a></p>
<p><a href="https://myzxcg.com/2021/08/Kerberos-%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E8%AF%A6%E7%BB%86%E5%88%86%E6%9E%90%E4%B8%80/"target="_blank" rel="external nofollow noopener noreferrer">Kerberos 认证过程详细分析（一）</a></p></div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="更新于 2022-11-24 17:37:22">更新于 2022-11-24&nbsp;</span>
      </div></div>
    <div class="post-info-line">
      <div class="post-info-md"></div>
      <div class="post-info-share">
        <span></span>
      </div>
    </div>
  </div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href='/tags/%E5%9F%9F%E6%B8%97%E9%80%8F/' class="post-tag">域渗透</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/posts/%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE/" class="post-nav-item" rel="prev" title="约束委派详解"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>约束委派详解</a>
      <a href="/posts/nopac-%E5%88%86%E6%9E%90/" class="post-nav-item" rel="next" title="noPac 分析">noPac 分析<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></main></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="回到顶部"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div></div><div id="mask"></div><noscript>
    <div class="noscript-warning">FixIt 主题在启用 JavaScript 的情况下效果最佳。</div>
  </noscript>
</div><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script>window.config={"code":{"copyTitle":"复制到剪贴板","editLockTitle":"锁定可编辑代码块","editUnLockTitle":"解锁可编辑代码块","editable":true,"maxShownLines":10},"comment":{"enable":false},"cookieconsent":{"content":{"dismiss":"同意","link":"了解更多","message":"本网站使用 Cookies 来改善您的浏览体验。"},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"}};</script><script src="/js/theme.min.js" defer></script></body>
</html>
